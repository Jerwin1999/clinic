{% extends 'admin/base-admin.html.twig' %}

{% block title %}Activity Logs{% endblock %}

{% block body %}
<div class="container-fluid">
    <h1 class="mb-4">üìä Activity Logs</h1>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow-sm">
                <div class="card-body">
                    <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                        üìä Total Logs
                    </div>
                    <div class="h5 mb-0 fw-bold text-gray-800">{{ totalLogs|number_format }}</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow-sm">
                <div class="card-body">
                    <div class="text-xs fw-bold text-success text-uppercase mb-1">
                        üìÖ Today's Logs
                    </div>
                    <div class="h5 mb-0 fw-bold text-gray-800">{{ todayLogs|number_format }}</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow-sm">
                <div class="card-body">
                    <div class="text-xs fw-bold text-danger text-uppercase mb-1">
                        üëë Admin Actions
                    </div>
                    <div class="h5 mb-0 fw-bold text-gray-800">{{ adminLogs|number_format }}</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow-sm">
                <div class="card-body">
                    <div class="text-xs fw-bold text-info text-uppercase mb-1">
                        üíº Staff Actions
                    </div>
                    <div class="h5 mb-0 fw-bold text-gray-800">{{ staffLogs|number_format }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Card with DataTable -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">System Activity Log</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" id="clearFilters">
                        üîÑ Clear Filters
                    </button>
                    <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
                        üóëÔ∏è Clear Old Logs
                    </button>
                </div>
            </div>

            <!-- DataTable -->
            <table id="activityLogsTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Action</th>
                        <th>Target Data</th>
                        <th>IP Address</th>
                        <th class="text-center">Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>#{{ log.id }}</td>
                        <td>
                            <div>
                                <div>{{ log.timestamp|date('Y-m-d') }}</div>
                                <small class="text-muted">{{ log.timestamp|date('H:i:s') }}</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <div>{{ log.username }}</div>
                                <small class="text-muted">ID: {{ log.userId }}</small>
                            </div>
                        </td>
                        <td>
                            {% if log.role == 'ROLE_SUPER_ADMIN' %}
                                <span class="badge bg-purple text-white">Super Admin</span>
                            {% elseif log.role == 'ROLE_ADMIN' %}
                                <span class="badge bg-danger">Admin</span>
                            {% elseif log.role == 'ROLE_STAFF' %}
                                <span class="badge bg-primary">Staff</span>
                            {% else %}
                                <span class="badge bg-success">User</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set action = log.action|upper %}
                            {% if action matches '/LOGIN/' %}
                                <span class="badge bg-success">{{ log.getActionReadable() }}</span>
                            {% elseif action matches '/LOGOUT/' %}
                                <span class="badge bg-secondary">{{ log.getActionReadable() }}</span>
                            {% elseif action matches '/CREATE/' %}
                                <span class="badge bg-info text-dark">{{ log.getActionReadable() }}</span>
                            {% elseif action matches '/UPDATE/' %}
                                <span class="badge bg-warning text-dark">{{ log.getActionReadable() }}</span>
                            {% elseif action matches '/DELETE/' %}
                                <span class="badge bg-danger">{{ log.getActionReadable() }}</span>
                            {% else %}
                                <span class="badge bg-dark">{{ log.getActionReadable() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.targetData %}
                                <span class="text-truncate d-inline-block" style="max-width: 150px;" 
                                      data-bs-toggle="tooltip" title="{{ log.targetData|e('html_attr') }}">
                                    {{ log.targetData }}
                                </span>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>
                            <code class="text-dark">{{ log.ipAddress ?? '‚Äî' }}</code>
                        </td>
                        <td class="text-center">
                            {% if log.details %}
                                <button class="btn btn-sm btn-outline-info view-details" 
                                        data-id="{{ log.id }}"
                                        data-details="{{ log.details|e('html_attr') }}">
                                    üëÅÔ∏è View
                                </button>
                            {% else %}
                                <span class="text-muted small">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No activity logs found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìã Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="detailsContent" class="bg-light p-3 rounded" style="white-space: pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyDetails()">Copy</button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö†Ô∏è Clear Old Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear logs older than:</p>
                <select class="form-control mb-3" id="daysToKeep">
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                </select>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmClearLogs">Clear Logs</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    const table = new DataTable('#activityLogsTable', {
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        pageLength: 25,
        order: [[1, 'desc']],
        language: {
            search: "üîç Search:",
            lengthMenu: "Show _MENU_ entries",
            zeroRecords: "No matching logs found",
            info: "Showing _START_ to _END_ of _TOTAL_ logs",
            infoEmpty: "No logs available",
            infoFiltered: "(filtered from _MAX_ total logs)"
        }
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // View details button handler
    document.querySelectorAll('.view-details').forEach(button => {
        button.addEventListener('click', function() {
            const details = this.dataset.details;
            try {
                document.getElementById('detailsContent').textContent = 
                    JSON.stringify(JSON.parse(details), null, 2);
            } catch (e) {
                document.getElementById('detailsContent').textContent = details;
            }
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        });
    });

    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', function() {
        table.search('').draw();
        this.blur();
    });

    // Clear logs functionality
    document.getElementById('confirmClearLogs').addEventListener('click', function() {
        const daysToKeep = document.getElementById('daysToKeep').value;
        
        if (confirm('Are you sure you want to clear logs older than ' + daysToKeep + ' days?')) {
            fetch('{{ path("app_activity_log_clear") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'days=' + daysToKeep
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
                bootstrap.Modal.getInstance(document.getElementById('clearLogsModal')).hide();
            })
            .catch(error => {
                alert('Error clearing logs');
                console.error('Error:', error);
            });
        }
    });
});

// Copy details to clipboard
function copyDetails() {
    const detailsText = document.getElementById('detailsContent').textContent;
    navigator.clipboard.writeText(detailsText).then(() => {
        alert('Details copied to clipboard!');
    }).catch(() => {
        // Fallback
        const textArea = document.createElement("textarea");
        textArea.value = detailsText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Details copied to clipboard!');
    });
}
</script>

<!-- Add this to your base-admin.html.twig or main CSS -->
<style>
.bg-purple {
    background-color: #6f42c1 !important;
}
.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}